# Demo 05 - Coverage Alto (80%)
# Aquí la mayoría de proyectos fallan - Es educativo

name: Demo 05 - Coverage 80% (Profesional)

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

env:
  COVERAGE_THRESHOLD: 80

jobs:
  coverage-profesional:
    name: "Coverage Profesional (80%)"
    runs-on: ubuntu-latest
    
    steps:
    # 1. Setup básico
    - name: Obtener código
      uses: actions/checkout@v4
    
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Instalar dependencias
      run: npm ci
    
    # 2. Información sobre este nivel
    - name: "¿Qué significa coverage 80%?"
      run: |
        echo "COVERAGE 80% - NIVEL PROFESIONAL"
        echo "=================================="
        echo ""
        echo "¿Qué significa?"
        echo "  → 80% de tu código está probado por tests"
        echo "  → Solo 20% del código sin probar"
        echo "  → Estándar que esperan las empresas"
        echo ""
        echo "¿Por qué la mayoría falla aquí?"
        echo "  → Necesitas tests para TODOS los casos"
        echo "  → No solo el 'caso feliz'"
        echo "  → Incluir validaciones y errores"
        echo ""
        echo "Si tu proyecto falla: ¡PERFECTO!"
        echo "  → Es una oportunidad de aprender"
        echo "  → Te motiva a escribir mejores tests"
        echo "  → Cuando lo logres, tendrás código confiable"
    
    # 3. Ejecutar tests con coverage
    - name: Ejecutar tests con coverage
      run: |
        echo "Ejecutando tests con análisis de coverage..."
        echo "Umbral objetivo: ${{ env.COVERAGE_THRESHOLD }}%"
        echo ""
        npm run test:coverage
    
    # 4. Verificación de coverage (puede fallar)
    - name: "Verificación de Coverage - Momento de la Verdad"
      run: |
        echo "VERIFICANDO COVERAGE..."
        echo "======================"
        echo ""
        echo "Extrayendo porcentaje de coverage del reporte..."
        
        # Método simplificado para extraer coverage
        COVERAGE_OUTPUT=$(npm run test:coverage 2>&1)
        
        # Buscar la línea que contiene "All files"
        COVERAGE_LINE=$(echo "$COVERAGE_OUTPUT" | grep "All files")
        
        if [ -n "$COVERAGE_LINE" ]; then
          echo "Línea de coverage encontrada:"
          echo "$COVERAGE_LINE"
          echo ""
          
          # Extraer el porcentaje (primer número decimal)
          COVERAGE_PERCENT=$(echo "$COVERAGE_LINE" | grep -oE '[0-9]+\.[0-9]+' | head -1)
          
          if [ -n "$COVERAGE_PERCENT" ]; then
            echo "Coverage extraído: $COVERAGE_PERCENT%"
            
            # Convertir a entero para comparación
            COVERAGE_INT=$(echo "$COVERAGE_PERCENT" | cut -d'.' -f1)
            THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
            
            echo ""
            echo "RESULTADO DE LA VERIFICACIÓN:"
            echo "  Coverage actual: $COVERAGE_PERCENT%"
            echo "  Threshold objetivo: $THRESHOLD%"
            echo ""
            
            if [ "$COVERAGE_INT" -lt "$THRESHOLD" ]; then
              echo "COVERAGE INSUFICIENTE"
              echo "   Faltante: $((THRESHOLD - COVERAGE_INT))%"
              echo ""
              echo "¡Esto es NORMAL y EDUCATIVO!"
              echo "  → La mayoría de proyectos fallan aquí"
              echo "  → Es una oportunidad de aprender"
              echo "  → Significa que necesitas más tests"
              exit 1  # Hacer que el paso falle
            else
              echo "COVERAGE EXCELENTE"
              echo "   ¡Felicitaciones! Tu proyecto tiene excelente cobertura"
            fi
          else
            echo "No se pudo extraer el porcentaje de coverage"
          fi
        else
          echo "No se encontró información de coverage en el reporte"
        fi
    
    # 5. Lección final (siempre se ejecuta)
    - name: "Lección: ¿Qué aprendemos del Coverage Alto?"
      if: always()
      run: |
        echo ""
        echo "EXPLICACIÓN DEL REPORTE:"
        echo "  Columns → | % Stmts | % Branch | % Funcs | % Lines |"
        echo "  Stmts:    Declaraciones ejecutadas"
        echo "  Branch:   Ramas de código (if/else) probadas"  
        echo "  Funcs:    Funciones llamadas en tests"
        echo "  Lines:    Líneas de código ejecutadas"
        